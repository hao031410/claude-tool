# CLAUDE.md

## 项目概述

通用新产品开发流程项目（`product-design`），从需求到产品的完整开发工作流。

## 核心工作流

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 1. 需求收集  │ →   │ 2. 产品设计  │ →   │ 3. UI 设计  │
│   brainstorming│    │  writing-plans│    │  用户选择方式 │
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                  │                  │
       ↓ 确认             ↓ 确认             ↓ 确认+预览
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 4. 系统设计  │ →   │ 5. 前端开发  │ →   │ 6. 后端开发  │
│   writing-plans│    │  subagent    │    │  subagent    │
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                  │                  │
       ↓ 确认             ↓                  ↓
┌─────────────────────────────────────────────────┐
│ 7. 自动化测试（根据需求生成用例）                │
│    - 必须全部通过才能交付                        │
│    - 失败则自动修复，重测，直到通过             │
└─────────────────┬───────────────────────────────┘
                  │
                  ↓ 全部通过 → 交付
                  ↓ 失败     → 返回修复
```

---

## 阶段规范

### 1. 需求收集
- **调用**: `brainstorming` skill
- **输出**: `.claude/doc/01-requirement.md`
- **内容**: 用户意图、功能清单、优先级标注（P0/P1/P2）
- **人工介入**: 需确认后才进入下一阶段
- **更新进度**: 完成后更新 `.claude/doc/00-progress.md`

### 2. 产品设计
- **调用**: `writing-plans` skill
- **输出**: `.claude/doc/02-product-design.md`
- **内容**: 产品方案、用户流程、功能描述、预留功能说明
- **人工介入**: 需确认后才进入下一阶段
- **更新进度**: 完成后更新 `.claude/doc/00-progress.md`

### 3. UI 设计（重要约束）
- **调用**: 询问用户选择生成方式，**不得擅自调用 API**
- **生成方式选项**:
  1. 本地 skill 生成（如 `ui-ux-pro-max`）
  2. 外部 AI 生成（用户自行调用）
  3. 手工设计
  4. 其他方式（用户指定）
- **必须输出**: `.claude/output/ui-preview.html`（或其他可预览格式）
- **UI 确认前检查**:
  1. 分析预览文件，提取所有功能点
  2. 与需求文档（`.claude/doc/01-requirement.md`）比对
  3. 发现预览中有而需求未定义的功能 → 立即与用户讨论：
     - 是否需要添加到需求？
     - 或标记为"预留功能"（UI 占位，MVP 不实现）
  4. 发现需求中有而预览缺失的功能 → 提示用户补充
- **前端开发约束**: 前端必须严格按照预览文件的风格、布局、组件去开发
- **输出文档**: `.claude/doc/03-ui-design.md`（样式规范、组件说明）
- **人工介入**: 需确认后才进入下一阶段
- **更新进度**: 完成后更新 `.claude/doc/00-progress.md`

### 4. 系统设计
- **调用**: `writing-plans` skill
- **输出**: `.claude/doc/04-system-design.md`
- **内容**:
  - 技术栈选择（默认 Spring Boot，可选 Next.js/Python/其他，选最新 LTS 版本）
  - 架构设计、数据模型、API 设计
  - 前后端分工
- **人工介入**: 需确认后才进入下一阶段
- **更新进度**: 完成后更新 `.claude/doc/00-progress.md`

### 5. 前端开发
- **调用**: `ui-ux-pro-max` + `subagent-driven-development`
- **输出**: `.claude/output/frontend/`
- **约束**:
  - 像素级还原：以 `.claude/output/ui-preview.html` 为唯一视觉源，布局、间距、字体、动画、颜色、圆角、阴影等差异 ≤1 px。 
  - 无设计稿的功能先做“预留区”（Placeholder），样式与周围元素保持一致，并标注 `TODO: pending design`。 
  - 每个 module 完成后更新进度文件
- **更新进度**: 每个模块完成后更新 `.claude/doc/00-progress.md`

### 6. 后端开发
- **调用**: `subagent-driven-development`
- **输出**: `.claude/output/backend/`
- **约束**: 每个 module 完成后更新进度文件
- **更新进度**: 每个模块完成后更新 `.claude/doc/00-progress.md`

### 7. 自动化测试（强制执行）
- **调用**: `verification-before-completion`
- **测试依据**: `.claude/doc/01-requirement.md` 中的需求
- **测试精度**: 按照 MVP、P0 等优先级执行
- **必须执行**:
  1. 根据需求文档自动生成测试用例
  2. 逐条执行测试用例
  3. **任何用例失败 → 自动修复代码 → 重新测试**
  4. **所有用例通过 → 才能交付**
- **输出**: `.claude/doc/07-test-report.md`（包含测试用例、执行结果、修复记录）
- **禁止**: 不得提示"人工验证"，必须自动测试完成
- **更新进度**: 测试完成后更新 `.claude/doc/00-progress.md`

---

## 中间产物目录

```
.claude/
├── doc/           # 文档类产物
│   ├── 00-progress.md         # ⭐ 进度跟踪（必须持续维护）
│   ├── 00-resume-prompt.md    # 新会话恢复提示词
│   ├── 01-requirement.md      # 需求文档
│   ├── 02-product-design.md   # 产品方案
│   ├── 03-ui-design.md        # UI 设计规范
│   ├── 04-system-design.md    # 系统设计
│   └── 07-test-report.md      # 测试报告
├── reference/     # 参考资料类
│   └── （按需添加）
├── script/        # 脚本类
│   └── （API 调用脚本等）
├── temp/          # 临时文件（随时可删）
└── output/        # 代码产物
    ├── ui-preview.html          # ⭐ UI 预览文件（必须生成）
    ├── frontend/  # 前端代码
    └── backend/   # 后端代码
```

---

## 进度文件维护约束（强制）

**目的**: 防止上下文压缩导致进度丢失

**何时更新**:
- ✅ 每个阶段开始前：记录开始时间、目标
- ✅ 每个阶段完成后：记录完成状态、输出文件位置
- ✅ 每个子任务/模块完成后：更新任务列表状态
- ✅ 每次上下文压缩前：生成新会话恢复提示词

**进度文件内容**:
```markdown
# 项目进度

## 当前进度
- 阶段 X: [进行中/已完成]
- 当前任务: 具体任务描述
- 最近完成: 列出最近完成的子任务

## 任务列表
- [x] 已完成任务
- [ ] 进行中任务
- [ ] 待办任务

## 重要决策
记录关键决策和原因

## 下一步行动
明确的下一步操作
```

---

## 工作流约束

### 强制约束
1. **人工确认点**: 未经确认不得进入下一阶段（阶段 1-6）
2. **UI 设计方式**: 必须让用户选择，不得擅自调用 API
3. **UI 预览文件**: 必须生成，且前端必须参照开发
4. **UI-需求比对**: 确认前必须比对，发现差异立即讨论
5. **自动化测试**: 开发完成后必须自动测试，不得提示人工验证
6. **测试通过才交付**: 所有测试用例通过才能交付，失败则自动修复
7. **进度文件维护**: 每个关键步骤后必须更新

### 开发原则
1. **最小变更原则**: 单次迭代只处理一个阶段
2. **MVP 标准**: P0 核心链路通过即可交付
3. **技术栈选择**: 在系统设计阶段确定，优先最新 LTS 版本
4. **测试闭环**: 失败则迭代，直至 P0 通过

---

## 代码原则

| 维度   | 要求                                      |
| ------ | ----------------------------------------- |
| 可读性 | 代码即注释；复杂逻辑必加注释              |
| 简洁性 | 不过度设计、不过早优化                    |
| 一致性 | 沿袭项目既有风格                          |
| 变更   | 最小化、兼容公共接口、及时清理死代码      |
| 安全   | 按 OWASP Top10 自检；外部输入先校验；秘钥不进仓库 |

---

## 新会话恢复流程

当上下文即将用完时：

1. **更新进度文件**: 记录当前所有进度
2. **生成恢复提示词**: 包含所有必要上下文
3. **在新会话中**: 先读取恢复提示词，再继续工作

恢复提示词位置: `.claude/doc/00-resume-prompt.md`
